<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>CATALOGO MAQUITEXT</title>

    <!-- Inter font -->
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap"
      rel="stylesheet"
    />

    <!-- Tailwind Play CDN (rápido para prototipos / sin build) -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- opcional: iconos Lucide -->
    <script src="https://unpkg.com/lucide@0.264.0/dist/lucide.min.js"></script>

    <!-- jsPDF + autotable -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

    <!-- SheetJS -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

    <style>
      html,
      body {
        height: 100%;
      }
      body {
        font-family: "Inter", system-ui, -apple-system, "Segoe UI", Roboto,
          "Helvetica Neue", Arial;
        background: linear-gradient(180deg, #f6f9ff 0%, #eef6ff 100%);
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
      }

      /* small custom for sticky table head shadow */
      thead th::after {
        content: "";
        position: absolute;
        left: 0;
        right: 0;
        bottom: 0;
        height: 6px;
        pointer-events: none;
        background: linear-gradient(
          180deg,
          rgba(255, 255, 255, 0),
          rgba(2, 6, 23, 0.02)
        );
      }
    </style>
  </head>
  <body class="min-h-screen">
    <div class="max-w-6xl mx-auto px-4 py-8">
      <!-- Header -->
      <header
        class="flex items-center gap-6 bg-white/60 backdrop-blur-sm rounded-2xl p-4 shadow-md"
      >
        <div class="flex items-center gap-4">
          <img
            src="/images/logo.jpg"
            alt="MAQUITEXT"
            class="h-16 w-auto object-contain rounded-md shadow-sm border"
            onerror="this.style.display='none'"
          />
          <div>
            <h1 class="text-2xl sm:text-3xl font-extrabold text-slate-900">
              MAQUITEXT
            </h1>
            <p class="text-sm text-slate-500">
              Generador de catálogos — administra, exporta e imprime
            </p>
          </div>
        </div>
        <div class="ml-auto flex gap-3 items-center">
          <button
            id="btnExportExcel"
            class="flex items-center gap-2 px-4 py-2 rounded-lg bg-gradient-to-r from-blue-600 to-blue-500 text-white shadow hover:scale-[0.995] transition-transform"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              class="h-4 w-4"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M12 3v12m9-9l-9 9-9-9"
              />
            </svg>
            Exportar Excel
          </button>
          <button
            id="btnImportExcel"
            class="flex items-center gap-2 px-4 py-2 rounded-lg border border-slate-200 bg-white text-slate-700 hover:shadow"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              class="h-4 w-4 text-slate-600"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M12 3v12m9-9l-9 9-9-9"
              />
            </svg>
            Importar Excel
          </button>
          <button
            id="btnGenerarPDF"
            class="flex items-center gap-2 px-4 py-2 rounded-lg bg-slate-800 text-white hover:bg-slate-900"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              class="h-4 w-4 text-white"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                stroke-linejoin="round"
                stroke-linecap="round"
                stroke-width="2"
                d="M7 17l5-5 5 5"
              />
            </svg>
            Generar PDF
          </button>
        </div>
      </header>

      <!-- Main panel -->
      <main class="mt-6 grid gap-6">
        <section class="bg-white rounded-2xl shadow p-6">
          <form
            id="formProducto"
            class="grid grid-cols-1 sm:grid-cols-3 gap-4 items-end"
            autocomplete="off"
          >
            <div>
              <label class="text-sm text-slate-600">Modelo</label>
              <input
                id="modelo"
                type="text"
                placeholder="Ej: MTX-2000"
                class="mt-1 block w-full rounded-lg border border-slate-200 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-300"
                required
              />
            </div>

            <div>
              <label class="text-sm text-slate-600">Descripción</label>
              <input
                id="descripcion"
                type="text"
                placeholder="Breve descripción del producto"
                class="mt-1 block w-full rounded-lg border border-slate-200 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-300"
                required
              />
            </div>

            <div>
              <label class="text-sm text-slate-600">Precio desde 6 UND</label>
              <input
                id="precio6"
                type="number"
                step="0.01"
                placeholder="0.00"
                class="mt-1 block w-full rounded-lg border border-slate-200 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-300"
                required
              />
            </div>

            <div>
              <label class="text-sm text-slate-600">Precio desde 12 UND</label>
              <input
                id="precio12"
                type="number"
                step="0.01"
                placeholder="0.00"
                class="mt-1 block w-full rounded-lg border border-slate-200 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-300"
                required
              />
            </div>

            <div>
              <label class="text-sm text-slate-600">Precio por unidad</label>
              <input
                id="unidades"
                type="number"
                step="0.01"
                placeholder="Precio por unidad (ej: 1.50)"
                class="mt-1 block w-full rounded-lg border border-slate-200 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-300"
                required
              />
            </div>

            <div>
              <label class="text-sm text-slate-600">Imagen (jpg/png)</label>
              <input
                id="imagen"
                type="file"
                accept="image/*"
                class="mt-1 block w-full text-sm text-slate-600"
              />
            </div>

            <!-- actions -->
            <div class="sm:col-span-3 flex items-center justify-between mt-2">
              <div class="flex gap-3">
                <button
                  id="btnAgregar"
                  type="submit"
                  class="btn-primary inline-flex items-center gap-2 px-4 py-2 rounded-lg bg-gradient-to-r from-blue-600 to-blue-500 text-white shadow"
                >
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    class="h-4 w-4"
                    fill="none"
                    viewBox="0 0 24 24"
                    stroke="currentColor"
                  >
                    <path
                      stroke-linejoin="round"
                      stroke-linecap="round"
                      stroke-width="2"
                      d="M12 4v16m8-8H4"
                    />
                  </svg>
                  Agregar producto
                </button>
                <button
                  id="btnCancelarEdicion"
                  type="button"
                  class="hidden px-3 py-2 rounded-lg bg-amber-500 text-white"
                  style="display: none"
                >
                  Cancelar edición
                </button>
              </div>

              <div class="flex items-center gap-3">
                <input
                  id="importExcelInput"
                  type="file"
                  accept=".xlsx, .xls"
                  class="hidden"
                />
                <button
                  id="btnExportExcel"
                  type="button"
                  class="px-3 py-2 rounded-lg border border-slate-200 bg-white hover:shadow"
                >
                  Exportar a Excel
                </button>
                <button
                  id="btnImportExcel"
                  type="button"
                  class="px-3 py-2 rounded-lg border border-slate-200 bg-white hover:shadow"
                >
                  Importar Excel
                </button>
                <button
                  id="btnGenerarPDF"
                  type="button"
                  class="px-3 py-2 rounded-lg bg-slate-800 text-white"
                >
                  Generar PDF
                </button>
              </div>
            </div>
          </form>

          <p class="mt-3 text-sm text-slate-500">
            Nota: las imágenes se almacenan en <strong>localStorage</strong>. El
            Excel exportado contiene únicamente datos editables (sin imágenes
            para evitar límites).
          </p>
        </section>

        <!-- Table -->
        <section class="bg-white rounded-2xl shadow p-2 overflow-auto">
          <div class="min-w-full">
            <table id="tablaProductos" class="min-w-full divide-y">
              <thead
                class="sticky top-0 bg-gradient-to-r from-blue-600 to-blue-500 text-white"
              >
                <tr class="text-left">
                  <th class="px-4 py-3 text-sm font-semibold">Imagen</th>
                  <th class="px-4 py-3 text-sm font-semibold">Modelo</th>
                  <th class="px-4 py-3 text-sm font-semibold">Descripción</th>
                  <th class="px-4 py-3 text-sm font-semibold">Precio 6 UND</th>
                  <th class="px-4 py-3 text-sm font-semibold">Precio 12 UND</th>
                  <th class="px-4 py-3 text-sm font-semibold">
                    Precio por unidad
                  </th>
                  <th class="px-4 py-3 text-sm font-semibold">Acciones</th>
                </tr>
              </thead>
              <tbody class="bg-white divide-y" id="tbodyProductos">
                <!-- rows injected by JS -->
              </tbody>
            </table>
          </div>
        </section>
      </main>
    </div>

    <script>
      /***********************
       * Mantengo tu lógica  *
       * sólo adapté selectores
       ***********************/

      // ---- Estado ----
      const STORAGE_KEY = "catalogo_maquitext_v1";
      let productos = [];
      let editIndex = -1;

      // Elementos
      const form = document.getElementById("formProducto");
      const modeloInput = document.getElementById("modelo");
      const descripcionInput = document.getElementById("descripcion");
      const precio6Input = document.getElementById("precio6");
      const precio12Input = document.getElementById("precio12");
      const unidadesInput = document.getElementById("unidades"); // ahora es precio por unidad
      const imagenInput = document.getElementById("imagen");

      const tablaBody = document.getElementById("tbodyProductos");
      const btnExportExcel = document.querySelectorAll("#btnExportExcel")[0]; // header & form buttons exist; use first
      const btnExportExcelForm =
        document.querySelectorAll("#btnExportExcel")[1]; // fallback
      const btnImportExcel = document.getElementById("btnImportExcel");
      const importExcelInput = document.getElementById("importExcelInput");
      const btnGenerarPDFs = document.querySelectorAll("#btnGenerarPDF");
      const btnGenerarPDF = btnGenerarPDFs[0] || btnGenerarPDFs[1];
      const btnCancelarEdicion = document.getElementById("btnCancelarEdicion");
      const btnAgregar = document.getElementById("btnAgregar");

      // Init
      loadFromStorage();
      renderTable();

      // ---- Form submit (agregar/editar) ----
      form.addEventListener("submit", (e) => {
        e.preventDefault();
        const modelo = modeloInput.value.trim();
        const descripcion = descripcionInput.value.trim();
        const precio6 = precio6Input.value.trim();
        const precio12 = precio12Input.value.trim();
        const precioUnidad = unidadesInput.value.trim(); // aquí almacenamos precio por unidad

        if (imagenInput.files && imagenInput.files.length > 0) {
          const file = imagenInput.files[0];
          const reader = new FileReader();
          reader.onload = function (ev) {
            const base64 = ev.target.result;
            saveProduct({
              modelo,
              descripcion,
              precio6,
              precio12,
              unidades: precioUnidad,
              imagen: base64,
            });
          };
          reader.readAsDataURL(file);
        } else {
          let imagen = "";
          if (editIndex >= 0 && productos[editIndex])
            imagen = productos[editIndex].imagen || "";
          saveProduct({
            modelo,
            descripcion,
            precio6,
            precio12,
            unidades: precioUnidad,
            imagen,
          });
        }
      });

      function saveProduct(obj) {
        if (editIndex >= 0) {
          productos[editIndex] = obj;
          editIndex = -1;
          btnCancelarEdicion.style.display = "none";
          btnAgregar.textContent = "Agregar producto";
        } else {
          productos.push(obj);
        }
        form.reset();
        imagenInput.value = "";
        saveToStorage();
        renderTable();
      }

      // ---- Render tabla ----
      function renderTable() {
        tablaBody.innerHTML = "";
        productos.forEach((p, idx) => {
          const tr = document.createElement("tr");
          tr.className = "hover:bg-slate-50";

          const tdImg = document.createElement("td");
          tdImg.className = "px-4 py-3";
          const img = document.createElement("img");
          img.className = "thumb";
          img.alt = "img";
          img.src = p.imagen || "";
          tdImg.appendChild(img);

          const tdModelo = document.createElement("td");
          tdModelo.className = "px-4 py-3 font-medium";
          tdModelo.textContent = p.modelo;
          const tdDesc = document.createElement("td");
          tdDesc.className = "px-4 py-3 text-sm text-slate-600";
          tdDesc.textContent = p.descripcion;
          const tdP6 = document.createElement("td");
          tdP6.className = "px-4 py-3";
          tdP6.innerHTML = `<span class="text-slate-400">$</span> <span class="font-semibold text-slate-900">${formatMoney(
            p.precio6
          )}</span>`;
          const tdP12 = document.createElement("td");
          tdP12.className = "px-4 py-3";
          tdP12.innerHTML = `<span class="text-slate-400">$</span> <span class="font-semibold text-slate-900">${formatMoney(
            p.precio12
          )}</span>`;
          const tdUn = document.createElement("td");
          tdUn.className = "px-4 py-3";
          tdUn.innerHTML = `<span class="text-slate-400">$</span> <span class="font-semibold text-slate-900">${formatMoney(
            p.unidades
          )}</span>`;

          const tdAcc = document.createElement("td");
          tdAcc.className = "px-4 py-3 flex gap-2";
          const btnEdit = document.createElement("button");
          btnEdit.textContent = "Editar";
          btnEdit.className = "px-3 py-1 rounded bg-blue-50 text-blue-700";
          btnEdit.onclick = () => startEdit(idx);
          const btnDel = document.createElement("button");
          btnDel.textContent = "Eliminar";
          btnDel.className = "px-3 py-1 rounded bg-red-50 text-red-600";
          btnDel.onclick = () => {
            if (confirm("Eliminar este producto?")) {
              productos.splice(idx, 1);
              saveToStorage();
              renderTable();
            }
          };

          tdAcc.appendChild(btnEdit);
          tdAcc.appendChild(btnDel);

          tr.appendChild(tdImg);
          tr.appendChild(tdModelo);
          tr.appendChild(tdDesc);
          tr.appendChild(tdP6);
          tr.appendChild(tdP12);
          tr.appendChild(tdUn);
          tr.appendChild(tdAcc);

          tablaBody.appendChild(tr);
        });
      }

      function startEdit(idx) {
        const p = productos[idx];
        if (!p) return;
        editIndex = idx;
        modeloInput.value = p.modelo || "";
        descripcionInput.value = p.descripcion || "";
        precio6Input.value = p.precio6 || "";
        precio12Input.value = p.precio12 || "";
        unidadesInput.value = p.unidades || ""; // precio por unidad
        imagenInput.value = "";
        btnCancelarEdicion.style.display = "inline-block";
        btnAgregar.textContent = "Guardar cambios";
        window.scrollTo({ top: 0, behavior: "smooth" });
      }

      btnCancelarEdicion.addEventListener("click", () => {
        editIndex = -1;
        form.reset();
        imagenInput.value = "";
        btnCancelarEdicion.style.display = "none";
        btnAgregar.textContent = "Agregar producto";
      });

      // ---- localStorage ----
      function saveToStorage() {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(productos));
      }
      function loadFromStorage() {
        try {
          const raw = localStorage.getItem(STORAGE_KEY);
          productos = raw ? JSON.parse(raw) : [];
        } catch (e) {
          productos = [];
        }
      }

      // ---- Export to Excel (sin imágenes) ----
      document.querySelectorAll("#btnExportExcel").forEach((btn) => {
        btn.addEventListener("click", () => {
          try {
            if (productos.length === 0) {
              alert("No hay productos para exportar");
              return;
            }
            const data = productos.map((p) => ({
              Modelo: p.modelo,
              Descripción: p.descripcion,
              "Precio 6 UND": p.precio6,
              "Precio 12 UND": p.precio12,
              "Precio por unidad": p.unidades,
            }));
            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Catalogo");
            XLSX.writeFile(wb, "catalogo_maquitext.xlsx");
          } catch (err) {
            console.error("Error exportando Excel:", err);
            alert("Ocurrió un error al generar el Excel. Revisa la consola.");
          }
        });
      });

      // ---- Import Excel (preserva imagen anterior si la fila no trae imagen) ----
      btnImportExcel.addEventListener("click", () => importExcelInput.click());
      importExcelInput.addEventListener("change", handleImportFile);

      function handleImportFile(ev) {
        const f = ev.target.files[0];
        if (!f) return;
        const reader = new FileReader();
        reader.onload = function (e) {
          const data = e.target.result;
          const workbook = XLSX.read(data, { type: "binary" });
          const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
          const json = XLSX.utils.sheet_to_json(firstSheet, { defval: "" });

          // Recorremos cada fila del excel y actualizamos/insertamos
          json.forEach((row) => {
            const modeloRow = row.Modelo || row.modelo || row.model || "";
            // buscar por modelo en productos existentes
            const existingIndex = productos.findIndex(
              (p) => p.modelo === modeloRow
            );

            const descripcionRow =
              row["Descripción"] ||
              row.Descripcion ||
              row.descripcion ||
              row.desc ||
              row.description ||
              "";
            const precio6Row =
              row["Precio 6 UND"] ||
              row.Precio6 ||
              row.precio6 ||
              row.price6 ||
              "";
            const precio12Row =
              row["Precio 12 UND"] ||
              row.Precio12 ||
              row.precio12 ||
              row.price12 ||
              "";
            const precioPorUnidadRow =
              row["Precio por unidad"] ||
              row["Precio por unidad".toUpperCase()] ||
              row.PrecioPorUnidad ||
              row.precioUnidad ||
              row.unidades ||
              row.Unidades ||
              "";

            // imagen: si excel trae campo ImagenBase64 lo usamos, si no, conservamos la anterior si existe
            const imagenRow =
              row.ImagenBase64 || row.imagen || row.Imagen || "";

            const nuevoProducto = {
              modelo: modeloRow,
              descripcion: descripcionRow,
              precio6: precio6Row,
              precio12: precio12Row,
              unidades: precioPorUnidadRow,
              imagen:
                imagenRow ||
                (existingIndex >= 0 ? productos[existingIndex].imagen : ""),
            };

            if (existingIndex >= 0) {
              productos[existingIndex] = nuevoProducto;
            } else {
              productos.push(nuevoProducto);
            }
          });

          saveToStorage();
          renderTable();
          importExcelInput.value = "";
          alert("Importación completa. Datos actualizados.");
        };
        reader.readAsBinaryString(f);
      }

      // ---- Generar PDF (logo + tabla con autotable, imágenes en primera columna) ----
      document
        .querySelectorAll("#btnGenerarPDF")
        .forEach((btn) => btn.addEventListener("click", generarPDF));

      function generarPDF() {
        if (productos.length === 0) {
          alert("No hay productos para generar PDF");
          return;
        }
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();

        // Intentar cargar logo desde /images/logo.jpg y convertir con canvas; si falla, usar texto
        const logoImg = new Image();
        logoImg.src = "/images/logo.jpg";
        logoImg.crossOrigin = "anonymous";
        logoImg.onload = function () {
          try {
            const canvas = document.createElement("canvas");
            canvas.width = logoImg.width;
            canvas.height = logoImg.height;
            const ctx = canvas.getContext("2d");
            ctx.drawImage(logoImg, 0, 0);
            const logoBase64 = canvas.toDataURL("image/jpeg");

            const pageWidth = doc.internal.pageSize.getWidth();
            const logoPDFWidth = 60;
            const logoPDFHeight =
              (logoImg.height * logoPDFWidth) / logoImg.width;
            const xLogo = (pageWidth - logoPDFWidth) / 2;
            const yLogo = 10;
            doc.addImage(
              logoBase64,
              "JPEG",
              xLogo,
              yLogo,
              logoPDFWidth,
              logoPDFHeight
            );

            addTableToDoc(doc, yLogo + logoPDFHeight + 8);
          } catch (e) {
            doc.setFontSize(18);
            doc.setTextColor(30, 58, 138);
            doc.text("CATALOGO MAQUITEXT", 105, 20, { align: "center" });
            addTableToDoc(doc, 30);
          }
        };

        logoImg.onerror = function () {
          doc.setFontSize(18);
          doc.setTextColor(30, 58, 138);
          doc.text("CATALOGO MAQUITEXT", 105, 20, { align: "center" });
          addTableToDoc(doc, 30);
        };

        function addTableToDoc(doc, startY) {
          doc.autoTable({
            startY,
            head: [
              [
                "Imagen",
                "Modelo",
                "Descripción",
                "Precio 6 UND",
                "Precio 12 UND",
                "Precio por unidad",
              ],
            ],
            body: productos.map((p) => [
              {
                content: "",
                styles: { cellWidth: 30, minCellHeight: 28 },
                imagen: p.imagen || "",
              },
              p.modelo,
              p.descripcion,
              `$${formatMoney(p.precio6)}`,
              `$${formatMoney(p.precio12)}`,
              `$${formatMoney(p.unidades)}`,
            ]),
            didDrawCell: function (data) {
              if (data.column.index === 0 && data.cell.section === "body") {
                const producto = productos[data.row.index];
                const b64 = producto && producto.imagen ? producto.imagen : "";
                if (b64) {
                  const dim = Math.min(26, data.cell.height - 4);
                  const x = data.cell.x + (data.cell.width - dim) / 2;
                  const y = data.cell.y + (data.cell.height - dim) / 2;
                  try {
                    doc.addImage(b64, "JPEG", x, y, dim, dim);
                  } catch (e) {}
                }
              }
            },
            styles: {
              valign: "middle",
              halign: "center",
              lineColor: [147, 197, 253],
              lineWidth: 0.2,
            },
            headStyles: { fillColor: [37, 99, 235], textColor: 255 },
            alternateRowStyles: { fillColor: [239, 246, 255] },
            margin: { left: 10, right: 10 },
          });
          doc.save("catalogo_maquitext.pdf");
        }
      }

      // ---- Helpers ----
      function formatMoney(v) {
        if (v === undefined || v === null || v === "") return "0.00";
        const n = Number(String(v).replace(/[^0-9.-]+/g, ""));
        if (Number.isNaN(n)) return "0.00";
        return n.toFixed(2);
      }
    </script>
  </body>
</html>
